{% extends "layouts/base.html" %}

{% block title %}{{ 'Edit Introduction' if page and page.is_introduction else ('Edit Page' if page and page.id else 'Create New Page') }} - neuralwired Portfolio{% endblock %}

{% block content %}
<header>
    <h1>{{ 'Edit Introduction' if page and page.is_introduction else ('Edit Page' if page and page.id else 'Create New Page') }}</h1>
    <div class="site-nav page-nav">
        <ul>
            <li>
                {% if page and page.is_introduction %}
                    <a href="{{ url_for('home') }}">← back to home</a>
                {% else %}
                    <a href="{{ url_for('manage_pages') }}">← back to page management</a>
                {% endif %}
            </li>
        </ul>
    </div>
</header>

{% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="flash-messages">
            {% for message in messages %}
                <p class="flash-message">{{ message }}</p>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

{% if page and page.is_introduction %}
    <!-- Introduction editor form -->
    <form action="{{ url_for('update_intro') }}" method="post" id="page-editor-form">
        <div class="form-group">
            <label for="content">Introduction Content:</label>
            <div class="editor-toolbar">
                <button type="button" class="toolbar-btn" data-command="bold"><i class="fas fa-bold"></i></button>
                <button type="button" class="toolbar-btn" data-command="italic"><i class="fas fa-italic"></i></button>
                <button type="button" class="toolbar-btn" data-command="underline"><i class="fas fa-underline"></i></button>
                <span class="toolbar-divider"></span>
                <button type="button" class="toolbar-btn" data-command="justifyLeft"><i class="fas fa-align-left"></i></button>
                <button type="button" class="toolbar-btn" data-command="justifyCenter"><i class="fas fa-align-center"></i></button>
                <button type="button" class="toolbar-btn" data-command="justifyRight"><i class="fas fa-align-right"></i></button>
                <span class="toolbar-divider"></span>
                <button type="button" class="toolbar-btn" data-command="createLink"><i class="fas fa-link"></i></button>
                <span class="toolbar-divider"></span>
                <select class="toolbar-select" data-command="fontSize">
                    <option value="1">Small</option>
                    <option value="3" selected>Normal</option>
                    <option value="5">Large</option>
                    <option value="7">X-Large</option>
                </select>
                <span class="toolbar-divider"></span>
                <button type="button" class="toolbar-btn" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                <button type="button" class="toolbar-btn" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="H1"><i class="fas fa-heading"></i> 1</button>
                <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="H2"><i class="fas fa-heading"></i> 2</button>
                <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="blockquote"><i class="fas fa-quote-right"></i></button>
            </div>
            <div id="content" class="content-editor" contenteditable="true">{{ page.content|safe }}</div>
            <textarea name="content" style="display: none;" id="content-textarea">{{ page.content }}</textarea>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn-primary">Save Introduction</button>
            <a href="{{ url_for('home') }}" class="btn-secondary">Cancel</a>
        </div>
    </form>
{% else %}
    <!-- Regular page editor form -->
    <form action="{{ url_for('update_existing_page', slug=page.slug) if page and page.slug else url_for('create_new_page') }}" method="post" id="page-editor-form">
        <div class="form-group">
            <label for="title">Title:</label>
            <input type="text" id="title" name="title" value="{{ page.title if page else '' }}" required class="full-width-input">
        </div>
        
        {% if not page or not page.slug %}
        <div class="form-group">
            <label for="slug">Slug (optional):</label>
            <input type="text" id="slug" name="slug" value="{{ page.slug if page else '' }}" class="full-width-input">
            <small class="input-help">If left blank, a slug will be generated from the title.</small>
        </div>
        {% endif %}
        
        <div class="form-group editor-options">
            <div class="checkbox-group">
                <input type="checkbox" id="is_blog" name="is_blog" {% if page and page.is_blog %}checked{% endif %}>
                <label for="is_blog">This is a blog post</label>
            </div>
            
            <div class="checkbox-group blog-option" {% if not page or not page.is_blog %}style="display: none;"{% endif %}>
                <input type="checkbox" id="featured" name="featured" {% if page and page.featured %}checked{% endif %}>
                <label for="featured">Featured post</label>
                <small class="input-help">Featured posts appear in the featured section on the homepage</small>
            </div>
        </div>
        
        <div class="form-group blog-option" {% if not page or not page.is_blog %}style="display: none;"{% endif %}>
            <label for="excerpt-editor">Excerpt (optional):</label>
            <div class="editor-toolbar excerpt-toolbar">
                <button type="button" class="toolbar-btn excerpt-btn" data-command="bold" data-target="excerpt-editor"><i class="fas fa-bold"></i></button>
                <button type="button" class="toolbar-btn excerpt-btn" data-command="italic" data-target="excerpt-editor"><i class="fas fa-italic"></i></button>
                <button type="button" class="toolbar-btn excerpt-btn" data-command="underline" data-target="excerpt-editor"><i class="fas fa-underline"></i></button>
                <button type="button" class="toolbar-btn excerpt-btn" data-command="insertParagraph" data-target="excerpt-editor"><i class="fas fa-paragraph"></i></button>
                <button type="button" class="toolbar-btn excerpt-btn" data-command="insertLineBreak" data-target="excerpt-editor"><i class="fas fa-level-down-alt fa-rotate-90"></i></button>
            </div>
            <div id="excerpt-editor" class="content-editor excerpt-editor" contenteditable="true">{{ page.excerpt|safe if page and page.excerpt else '' }}</div>
            <textarea id="excerpt" name="excerpt" style="display: none;">{{ page.excerpt if page and page.excerpt else '' }}</textarea>
            <small class="input-help">A short summary of the post. If left blank, an excerpt will be generated from the content.</small>
        </div>
        
        <div class="form-group">
            <label for="content">Content:</label>
            <div class="editor-toolbar">
                <button type="button" class="toolbar-btn" data-command="bold"><i class="fas fa-bold"></i></button>
                <button type="button" class="toolbar-btn" data-command="italic"><i class="fas fa-italic"></i></button>
                <button type="button" class="toolbar-btn" data-command="underline"><i class="fas fa-underline"></i></button>
                <span class="toolbar-divider"></span>
                <button type="button" class="toolbar-btn" data-command="justifyLeft"><i class="fas fa-align-left"></i></button>
                <button type="button" class="toolbar-btn" data-command="justifyCenter"><i class="fas fa-align-center"></i></button>
                <button type="button" class="toolbar-btn" data-command="justifyRight"><i class="fas fa-align-right"></i></button>
                <span class="toolbar-divider"></span>
                <button type="button" class="toolbar-btn" data-command="createLink"><i class="fas fa-link"></i></button>
                <span class="toolbar-divider"></span>
                <select class="toolbar-select" data-command="fontSize">
                    <option value="1">Small</option>
                    <option value="3" selected>Normal</option>
                    <option value="5">Large</option>
                    <option value="7">X-Large</option>
                </select>
                <span class="toolbar-divider"></span>
                <button type="button" class="toolbar-btn" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                <button type="button" class="toolbar-btn" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="H1"><i class="fas fa-heading"></i> 1</button>
                <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="H2"><i class="fas fa-heading"></i> 2</button>
                <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="blockquote"><i class="fas fa-quote-right"></i></button>
            </div>
            <div id="content" class="content-editor" contenteditable="true">{{ page.content|safe if page else '' }}</div>
            <textarea name="content" style="display: none;" id="content-textarea">{{ page.content if page else '' }}</textarea>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn-primary">Save Page</button>
            <a href="{{ url_for('manage_pages') }}" class="btn-secondary">Cancel</a>
        </div>
    </form>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle toolbar buttons
        document.querySelectorAll('.toolbar-btn').forEach(button => {
            button.addEventListener('click', function() {
                const command = this.dataset.command;
                const value = this.dataset.value || '';
                
                if (command === 'createLink') {
                    const url = prompt('Enter the URL:', 'https://');
                    if (url) {
                        document.execCommand(command, false, url);
                    }
                } else {
                    document.execCommand(command, false, value);
                }
                
                // Focus back on editor
                document.getElementById('content').focus();
            });
        });
        
        // Handle font size change
        document.querySelectorAll('.toolbar-select').forEach(select => {
            select.addEventListener('change', function() {
                document.execCommand(this.dataset.command, false, this.value);
                document.getElementById('content').focus();
            });
        });
        
        // Toggle blog options visibility
        const isBlogCheckbox = document.getElementById('is_blog');
        if (isBlogCheckbox) {
            const blogOptions = document.querySelectorAll('.blog-option');
            
            isBlogCheckbox.addEventListener('change', function() {
                blogOptions.forEach(option => {
                    option.style.display = this.checked ? 'block' : 'none';
                });
            });
        }
        
        // Form submission - copy contenteditable to textarea
        // This is the critical part that ensures the content is saved correctly
        const form = document.getElementById('page-editor-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                // Prevent default form submission
                e.preventDefault();
                
                // Copy content from contenteditable div to hidden textarea
                const contentHtml = document.getElementById('content').innerHTML;
                document.getElementById('content-textarea').value = contentHtml;
                
                // Copy excerpt content if it exists
                const excerptEditor = document.getElementById('excerpt-editor');
                if (excerptEditor) {
                    const excerptHtml = excerptEditor.innerHTML;
                    document.getElementById('excerpt').value = excerptHtml;
                    console.log("Saving excerpt:", excerptHtml);
                }
                
                // Log the content being saved (for debugging)
                console.log("Saving content:", contentHtml);
                
                // Submit the form
                this.submit();
            });
        }
        
        // Handle excerpt toolbar buttons separately
        document.querySelectorAll('.excerpt-btn').forEach(button => {
            button.addEventListener('click', function() {
                const command = this.dataset.command;
                const value = this.dataset.value || '';
                
                // Focus on the excerpt editor
                const excerptEditor = document.getElementById('excerpt-editor');
                excerptEditor.focus();
                
                if (command === 'insertParagraph') {
                    // Insert paragraph break
                    document.execCommand('insertHTML', false, '</p><p>');
                } else if (command === 'insertLineBreak') {
                    // Insert line break
                    document.execCommand('insertHTML', false, '<br>');
                } else {
                    // Execute regular formatting command
                    document.execCommand(command, false, value);
                }
            });
        });
    });
</script>
{% endblock %}
